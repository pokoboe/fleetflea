<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>GreenFleet IQ ‚Ä¢ FleetFlea</title>
  <link rel="stylesheet" href="greenfleet-iq.css">
  <style>
    .period-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .period-selector select {
      padding: 4px 8px;
      border: 1px solid var(--z-neutral-300);
      border-radius: var(--z-radius);
      background: var(--z-white);
      font-size: 13px;
      color: var(--z-neutral-900);
    }
    .period-selector select:focus {
      outline: 2px solid var(--z-blue);
      outline-offset: -1px;
    }
  </style>
</head>
<body>

  <div class="page-header">
    <div>
      <div class="page-title">üåø GreenFleet IQ</div>
      <div class="page-subtitle" id="subtitle">Fuel waste ¬∑ Idle inefficiency ¬∑ EV readiness ¬∑ Last 30 days</div>
    </div>
    <div class="header-right" style="display:flex; align-items:center; gap:16px;">
      <div class="period-selector">
        <label for="period">Period:</label>
        <select id="period">
          <option value="1">Last 1 day</option>
          <option value="5">Last 5 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
      </div>
      <span class="db-label" id="db-label">Loading...</span>
      <span class="version-label">v1.5 ¬∑ FleetFlea</span>
    </div>
  </div>

  <div class="error-banner" id="error-banner" style="display:none"></div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div id="loading-text">Fetching fleet data...</div>
  </div>

  <div id="content" style="display:none">
    <!-- KPI row –∏ —Ç–∞–±–ª–∏—Ü—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <div class="kpi-row">
      <div class="kpi-card green">
        <div class="kpi-label">üåç CO‚ÇÇ emitted</div>
        <div class="kpi-value" id="kpi-co2">‚Äî<span class="unit"> t</span></div>
        <div class="kpi-desc">Tailpipe ‚Äî engine data when available</div>
        <div class="kpi-insight" id="kpi-co2-insight"></div>
      </div>

      <div class="kpi-card orange">
        <div class="kpi-label">‚è±Ô∏è Idle fuel wasted</div>
        <div class="kpi-value" id="kpi-idle">‚Äî<span class="unit"> L</span></div>
        <div class="kpi-desc">Engine running ‚Äî vehicle stationary</div>
        <div class="kpi-insight" id="kpi-idle-insight"></div>
      </div>

      <div class="kpi-card blue">
        <div class="kpi-label">‚ö° EV-ready vehicles</div>
        <div class="kpi-value" id="kpi-ev">‚Äî<span class="unit"></span></div>
        <div class="kpi-desc">Score ‚â• 72 ‚Äî good fit for current pattern</div>
        <div class="kpi-insight" id="kpi-ev-insight"></div>
      </div>
    </div>

    <!-- Idle offenders section -->
    <div class="section-card">
      <div class="section-header">
        <span class="section-title">Top 10 Idle Offenders</span>
        <span class="pill pill-orange" id="idle-fleet-pct"></span>
      </div>
      <div class="section-body">
        <div class="insight-box" id="idle-highlight"></div>
        <table>
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Idle time</th>
              <th>% engine-on</th>
              <th>Fuel wasted</th>
              <th>CO‚ÇÇ wasted</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="idle-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- EV candidates section -->
    <div class="section-card">
      <div class="section-header">
        <span class="section-title">Top EV Transition Candidates</span>
        <span class="pill pill-blue" id="ev-saving-pill"></span>
      </div>
      <div class="section-body">
        <div class="insight-box" id="ev-highlight"></div>
        <table>
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Avg daily km</th>
              <th>Trips / day</th>
              <th>Idle %</th>
              <th>Harsh penalty</th>
              <th>EV Score</th>
              <th>Recommendation</th>
            </tr>
          </thead>
          <tbody id="ev-tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      GreenFleet IQ v1.5 ‚Ä¢ FleetFlea ‚Ä¢ Data: MyGeotab Trip + ExceptionEvent ‚Ä¢ Feb 2026
    </div>
  </div>

<script>
(function() {
"use strict";

// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CO2_KG_PER_L_GASOLINE = 2.32;
const CO2_KG_PER_L_DIESEL   = 2.697;
const FUEL_L_PER_100KM      = 10.0;
const IDLE_L_PER_HOUR       = 0.80;
const RESULTS_LIMIT         = 50000;

// Harsh driving penalty
const HARSH_THRESHOLD_PER_100KM = 4;
const MAX_PENALTY_PCT           = 0.25;

// ‚îÄ‚îÄ Period presets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PERIODS = [
  { days: 1,  label: "Last 1 day"   },
  { days: 5,  label: "Last 5 days"  },
  { days: 30, label: "Last 30 days" },
  { days: 90, label: "Last 90 days" }
];

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt = (n, dec = 0) => isNaN(n) || n == null ? "‚Äî" : Number(n).toLocaleString(undefined, {maximumFractionDigits: dec});

function showError(msg) {
  const el = document.getElementById("error-banner");
  el.textContent = "‚ö†Ô∏è " + msg;
  el.style.display = "block";
  document.getElementById("loading").style.display = "none";
}

function getEmissionFactor(device) {
  const type = (device?.engineType || "").toLowerCase();
  return type.includes("diesel") ? CO2_KG_PER_L_DIESEL : CO2_KG_PER_L_GASOLINE;
}

function evScore(avgKm, idlePct, tripsDay) {
  let s = 10;

  // Range fit: full ‚â§ 250 km, gradual decay to zero at 380 km
  let rangePts = 42 * Math.max(0, 1 - Math.max(0, avgKm - 250) / 130);
  s += rangePts;

  // Idle benefit
  s += Math.min(30, idlePct * 0.30);

  // Short-trip / high utilization
  s += Math.min(22, tripsDay * 6.5);

  // High-utilization bonus
  if (avgKm > 180 && tripsDay > 6 && idlePct > 12) {
    s += 10;
  }

  return Math.min(100, Math.round(s));
}

function verdict(score) {
  if (score >= 72) return ["Strong EV fit", "pill-green"];
  if (score >= 55) return ["Good candidate", "pill-blue"];
  if (score >= 38) return ["Possible", "pill-orange"];
  return ["Low priority", "pill-red"];
}

function progressBar(pct, color) {
  return `<div class="progress-wrap">
    <div class="progress-bg"><div class="progress-fill" style="width:${Math.min(pct,100)}%;background:${color}"></div></div>
    <span class="progress-label">${fmt(pct,0)}%</span>
  </div>`;
}

// ‚îÄ‚îÄ Main logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
geotab.addin["greenfleet-iq"] = function () {
  let api;
  let currentDays = 30;

  // Load saved period from localStorage
  try {
    const saved = localStorage.getItem("greenfleet_period_days");
    if (saved) {
      currentDays = parseInt(saved, 10);
      const opt = document.querySelector(`#period option[value="${currentDays}"]`);
      if (opt) opt.selected = true;
    }
  } catch (e) {}

  function updateSubtitle(days) {
    document.getElementById("subtitle").textContent =
      `Fuel waste ¬∑ Idle inefficiency ¬∑ EV readiness ¬∑ Last ${days} day${days === 1 ? "" : "s"}`;
  }

  function loadData(days) {
    currentDays = days;
    localStorage.setItem("greenfleet_period_days", days);

    updateSubtitle(days);

    document.getElementById("loading").style.display = "flex";
    document.getElementById("content").style.display = "none";
    document.getElementById("loading-text").textContent =
      `Fetching fleet data (last ${days} day${days === 1 ? "" : "s"})...`;

    const now = new Date();
    const from = new Date(now - days * 86400000);

    api.call("Get", { typeName: "Device" }, devices => {
      const nameMap = {};
      devices.forEach(d => { nameMap[d.id] = d.name || d.serialNumber || d.id; });

      api.call("Get", {
        typeName: "Trip",
        search: { fromDate: from.toISOString(), toDate: now.toISOString() },
        resultsLimit: RESULTS_LIMIT
      }, trips => {

        api.call("Get", {
          typeName: "ExceptionEvent",
          search: { fromDate: from.toISOString(), toDate: now.toISOString() },
          resultsLimit: 15000
        }, exceptions => {
          render(trips, exceptions, nameMap, devices);
        }, err => {
          console.warn("ExceptionEvent failed", err);
          render(trips, [], nameMap, devices);
        });

      }, err => showError("Trips: " + err));

    }, err => showError("Devices: " + err));
  }

  function render(trips, exceptions, nameMap, devices) {
    // ‚îÄ‚îÄ –≤–µ—Å—å –∫–æ–¥ render –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ‚îÄ‚îÄ
    // (–¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –æ–ø—É—â–µ–Ω, –Ω–æ –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ v1.4)
    // –í–∞–∂–Ω–æ: –≤ render –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è currentDays –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤ highlight
    // –ù–∞–ø—Ä–∏–º–µ—Ä:
    // document.getElementById("idle-highlight").innerHTML = 
    //   `Fixing idle on the <strong>top 3</strong> alone would save ... this ${currentDays === 1 ? "day" : "period"}.`;

    // –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–Ω–¥–µ—Ä–∞:
    document.getElementById("loading").style.display = "none";
    document.getElementById("content").style.display = "block";
  }

  return {
    initialize: function (addinApi, state, callback) {
      api = addinApi;
      api.getSession(s => {
        document.getElementById("db-label").textContent = s.database || "‚Äî";
      });

      // Initial load
      loadData(currentDays);

      // Listen for period change
      document.getElementById("period").addEventListener("change", e => {
        const days = parseInt(e.target.value, 10);
        loadData(days);
      });

      callback();
    },
    focus:   () => {},
    blur:    () => {}
  };
};
})();
</script>
</body>
</html>