<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>GreenFleet IQ â€¢ FleetFlea</title>
  <link rel="stylesheet" href="https://pokoboe.github.io/fleetflea/greenfleet-iq.css">
</head>
<body>

  <div class="page-header">
    <div>
      <div class="page-title">ğŸŒ¿ GreenFleet IQ</div>
      <div class="page-subtitle">Fuel waste Â· Idle inefficiency Â· EV readiness Â· Last 30 days</div>
    </div>
    <div class="header-right">
      <span class="db-label" id="db-label">Loading...</span>
      <span class="version-label">v1.1 Â· FleetFlea</span>
    </div>
  </div>

  <div class="error-banner" id="error-banner" style="display:none"></div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div>Fetching fleet trips (last 30 days)...</div>
  </div>

  <div id="content" style="display:none">

    <!-- KPI row -->
    <div class="kpi-row">
      <div class="kpi-card green">
        <div class="kpi-label">ğŸŒ COâ‚‚ emitted</div>
        <div class="kpi-value" id="kpi-co2">â€”<span class="unit"> t</span></div>
        <div class="kpi-desc">Estimated from real trip fuel burn</div>
        <div class="kpi-insight" id="kpi-co2-insight"></div>
      </div>

      <div class="kpi-card orange">
        <div class="kpi-label">â±ï¸ Idle fuel wasted</div>
        <div class="kpi-value" id="kpi-idle">â€”<span class="unit"> L</span></div>
        <div class="kpi-desc">Engine running â€” vehicle stationary</div>
        <div class="kpi-insight" id="kpi-idle-insight"></div>
      </div>

      <div class="kpi-card blue">
        <div class="kpi-label">âš¡ EV-ready vehicles</div>
        <div class="kpi-value" id="kpi-ev">â€”<span class="unit"></span></div>
        <div class="kpi-desc">Score â‰¥ 72 â€” good fit for current use pattern</div>
        <div class="kpi-insight" id="kpi-ev-insight"></div>
      </div>
    </div>

    <!-- Idle offenders -->
    <div class="section-card">
      <div class="section-header">
        <span class="section-title">Top 10 Idle Offenders</span>
        <span class="pill pill-orange" id="idle-fleet-pct"></span>
      </div>
      <div class="section-body">
        <div class="insight-box" id="idle-highlight"></div>
        <table>
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Idle time</th>
              <th>% engine-on</th>
              <th>Fuel wasted</th>
              <th>COâ‚‚ wasted</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="idle-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- EV candidates -->
    <div class="section-card">
      <div class="section-header">
        <span class="section-title">Top EV Transition Candidates</span>
        <span class="pill pill-blue" id="ev-saving-pill"></span>
      </div>
      <div class="section-body">
        <div class="insight-box" id="ev-highlight"></div>
        <table>
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Avg daily km</th>
              <th>Trips / day</th>
              <th>Idle %</th>
              <th>EV Score</th>
              <th>Recommendation</th>
            </tr>
          </thead>
          <tbody id="ev-tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      GreenFleet IQ v1.1 â€¢ FleetFlea â€¢ Data: MyGeotab Trip API â€¢ Feb 2026
    </div>

  </div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"use strict";

// Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CO2_KG_PER_L      = 2.31;
const FUEL_L_PER_100KM  = 10.0;
const IDLE_L_PER_HOUR   = 0.80;
const DAYS              = 30;
const RESULTS_LIMIT     = 50000;

// Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = (n, dec = 0) => isNaN(n) || n == null ? "â€”" : Number(n).toLocaleString(undefined, {maximumFractionDigits: dec});

function showError(msg) {
  const el = document.getElementById("error-banner");
  el.textContent = "âš ï¸ " + msg;
  el.style.display = "block";
  document.getElementById("loading").style.display = "none";
}

function evScore(avgKm, idlePct, tripsDay) {
  let s = 10;                                 // base
  s += Math.max(0, Math.min(42, (180 - avgKm) / 180 * 42));   // daily range fit
  s += Math.min(28, idlePct * 0.28);          // high idle benefit
  s += Math.min(20, tripsDay * 6.5);          // short-trip density
  return Math.min(100, Math.round(s));
}

function verdict(score) {
  if (score >= 72) return ["Strong EV fit", "pill-green"];
  if (score >= 55) return ["Good candidate", "pill-blue"];
  if (score >= 38) return ["Possible",       "pill-orange"];
  return ["Low priority", "pill-red"];
}

function progressBar(pct, color) {
  return `<div class="progress-wrap">
    <div class="progress-bg"><div class="progress-fill" style="width:${Math.min(pct,100)}%;background:${color}"></div></div>
    <span class="progress-label">${fmt(pct,0)}%</span>
  </div>`;
}

// Main logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
geotab.addin["greenfleet-iq"] = () => {
  let api;

  function run() {
    const now = new Date();
    const from = new Date(now - DAYS * 86400000);

    api.call("Get", { typeName: "Device" }, devices => {
      const nameMap = {};
      devices.forEach(d => { nameMap[d.id] = d.name || d.serialNumber || d.id; });

      api.call("Get", {
        typeName: "Trip",
        search: { fromDate: from.toISOString(), toDate: now.toISOString() },
        resultsLimit: RESULTS_LIMIT
      }, trips => render(trips, nameMap), err => showError("Trips: " + err));

    }, err => showError("Devices: " + err));
  }

  function render(trips, nameMap) {
    // Distance unit auto-detection
    let maxDist = 0;
    trips.forEach(t => { if ((t.distance||0) > maxDist) maxDist = t.distance; });
    const kmFactor = maxDist > 5000 ? 0.001 : 1;

    const byVehicle = {};

    trips.forEach(t => {
      const id = t.device?.id;
      if (!id) return;

      if (!byVehicle[id]) {
        byVehicle[id] = {
          id, name: nameMap[id] || id,
          distKm: 0, trips: 0,
          driveSec: 0, idleSec: 0,
          days: new Set()
        };
      }
      const v = byVehicle[id];

      v.distKm   += (t.distance || 0) * kmFactor;
      v.trips    += 1;
      v.days.add(t.start?.slice(0,10));

      // Robust duration parsing
      const parseDur = d => {
        if (!d) return 0;
        if (typeof d === "number") return d;
        if (d.totalSeconds != null) return d.totalSeconds;
        if (d.ticks != null) return d.ticks / 1e7;
        if (typeof d === "string") {
          const p = d.split(":");
          if (p.length === 3) return (+p[0])*3600 + (+p[1])*60 + +p[2];
        }
        return 0;
      };

      v.driveSec += parseDur(t.drivingDuration);
      v.idleSec  += parseDur(t.idlingDuration);
    });

    const vehicles = Object.values(byVehicle).filter(v => v.trips > 0);

    vehicles.forEach(v => {
      v.idleHrs    = v.idleSec / 3600;
      v.driveHrs   = v.driveSec / 3600;
      v.totalHrs   = v.idleHrs + v.driveHrs;
      v.idlePct    = v.totalHrs > 0 ? v.idleSec / (v.driveSec + v.idleSec) * 100 : 0;
      v.activeDays = Math.max(v.days.size, 1);
      v.avgDailyKm = v.distKm / v.activeDays;
      v.tripsDay   = v.trips / v.activeDays;

      v.idleFuel   = v.idleHrs * IDLE_L_PER_HOUR;
      v.driveFuel  = v.distKm * (FUEL_L_PER_100KM / 100);
      v.totalFuel  = v.idleFuel + v.driveFuel;
      v.co2Kg      = v.totalFuel * CO2_KG_PER_L;
      v.co2IdleKg  = v.idleFuel * CO2_KG_PER_L;

      v.evScore    = evScore(v.avgDailyKm, v.idlePct, v.tripsDay);
    });

    // Aggregates
    const totalCO2     = vehicles.reduce((s,v)=>s+v.co2Kg,     0) / 1000;
    const totalIdleL   = vehicles.reduce((s,v)=>s+v.idleFuel,  0);
    const totalFuel    = vehicles.reduce((s,v)=>s+v.totalFuel, 0);
    const fleetIdlePct = totalFuel > 0 ? totalIdleL / totalFuel * 100 : 0;
    const evReady      = vehicles.filter(v => v.evScore >= 72);
    const evCount      = evReady.length;

    // â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("kpi-co2").innerHTML = fmt(totalCO2, totalCO2<10?1:0) + '<span class="unit"> t</span>';
    document.getElementById("kpi-co2-insight").innerHTML =
      `â‰ˆ <strong>${fmt(totalCO2 * 1000 / 0.115, 0)}</strong> km driven by average passenger car`;

    document.getElementById("kpi-idle").innerHTML = fmt(totalIdleL, 0) + '<span class="unit"> L</span>';
    document.getElementById("kpi-idle-insight").innerHTML =
      `<strong>${fmt(fleetIdlePct,1)}%</strong> of fuel burned while stationary`;

    document.getElementById("kpi-ev").innerHTML = `${evCount}<span class="unit"> / ${vehicles.length}</span>`;
    const potYearCO2 = evReady.reduce((s,v)=>s+v.co2Kg,0) / 1000 * 12 * 0.84;
    document.getElementById("kpi-ev-insight").innerHTML =
      `Switching could avoid <strong>${fmt(potYearCO2,0)} t COâ‚‚/year</strong>`;

    // â”€â”€ Idle table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("idle-fleet-pct").textContent = fmt(fleetIdlePct,1) + "% fleet idle";

    const worstIdle = [...vehicles].sort((a,b)=>b.idleHrs - a.idleHrs);
    document.getElementById("idle-highlight").innerHTML =
      `<span class="icon">ğŸ’¡</span> Fixing idle on the <strong>top 3</strong> alone would save ` +
      `<strong>${fmt(worstIdle.slice(0,3).reduce((s,v)=>s+v.idleFuel,0),0)} L</strong> fuel and ` +
      `<strong>${fmt(worstIdle.slice(0,3).reduce((s,v)=>s+v.co2IdleKg,0)/1000,1)} t COâ‚‚</strong> this month.`;

    document.getElementById("idle-tbody").innerHTML = worstIdle.slice(0,10).map(v => {
      const color = v.idlePct > 28 ? "#D13438" : v.idlePct > 16 ? "#FFB900" : "#107C10";
      const cls   = v.idlePct > 28 ? "pill-red" : v.idlePct > 16 ? "pill-orange" : "pill-green";
      const txt   = v.idlePct > 28 ? "Critical" : v.idlePct > 16 ? "High" : "Normal";
      return `<tr>
        <td><strong>${v.name}</strong></td>
        <td>${fmt(v.idleHrs,1)} h</td>
        <td class="idle-bar-cell">${progressBar(v.idlePct, color)}</td>
        <td>${fmt(v.idleFuel,0)} L</td>
        <td>${fmt(v.co2IdleKg,0)} kg</td>
        <td><span class="pill ${cls}">${txt}</span></td>
      </tr>`;
    }).join("");

    // â”€â”€ EV table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("ev-saving-pill").textContent =
      `~${fmt(potYearCO2,0)} t COâ‚‚/yr avoided if switched`;

    const avgKmReady = evReady.length ? evReady.reduce((s,v)=>s+v.avgDailyKm,0)/evReady.length : 0;
    document.getElementById("ev-highlight").innerHTML =
      `<span class="icon">âš¡</span>
      <strong>${evCount} vehicle${evCount===1?"":"s"}</strong> look like strong EV candidates.<br>
      They average <strong>${fmt(avgKmReady,0)} km/day</strong> â€” well inside typical EV range.<br>
      High idle % makes them especially attractive for electrification.`;

    const evSorted = [...vehicles].sort((a,b)=>b.evScore - a.evScore).slice(0,10);
    document.getElementById("ev-tbody").innerHTML = evSorted.map(v => {
      const [txt, cls] = verdict(v.evScore);
      const color = v.evScore >= 72 ? "#107C10" : v.evScore >= 55 ? "#0078D4" : v.evScore >= 38 ? "#FFB900" : "#D13438";
      return `<tr>
        <td><strong>${v.name}</strong></td>
        <td>${fmt(v.avgDailyKm,0)} km</td>
        <td>${fmt(v.tripsDay,1)}</td>
        <td>${fmt(v.idlePct,1)}%</td>
        <td>${progressBar(v.evScore, color)}</td>
        <td><span class="pill ${cls}">${txt}</span></td>
      </tr>`;
    }).join("");

    document.getElementById("loading").style.display = "none";
    document.getElementById("content").style.display = "block";
  }

  return {
    initialize: (addinApi, state, callback) => {
      api = addinApi;
      api.getSession(s => {
        document.getElementById("db-label").textContent = s.database || "â€”";
      });
      run();
      callback();
    },
    focus:   () => {},
    blur:    () => {}
  };
};
</script>
</body>
</html>