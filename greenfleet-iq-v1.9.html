<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>GreenFleet IQ ‚Ä¢ FleetFlea</title>
  <link rel="stylesheet" href="greenfleet-iq.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

  <!-- Tab Navigation -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="dashboard">üìä Idle & EV Analysis</button>
    <button class="tab-btn" data-tab="map">‚ö° EV Charging Readiness</button>
  </div>

  <!-- DASHBOARD TAB -->
  <div id="dashboard" class="tab-content">
    <!-- —Ç–≤–æ–π —Ç–µ–∫—É—â–∏–π –∫–æ–¥ KPI + —Ç–∞–±–ª–∏—Ü—ã (—è –æ—Å—Ç–∞–≤–∏–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–∞–∫ –≤ v1.7) -->
    <div class="page-header">
      <div>
        <div class="page-title">üåø GreenFleet IQ</div>
        <div class="page-subtitle" id="page-subtitle">Fuel waste ¬∑ Idle inefficiency ¬∑ EV readiness ¬∑ Last 30 days</div>
      </div>
      <div class="header-right">
        <select id="range-select">
          <option value="1">Last day</option>
          <option value="5">Last 5 days</option>
          <option value="30" selected>Last 30 days</option>
        </select>
        <span class="db-label" id="db-label">Loading...</span>
        <span class="version-label">v1.8 ¬∑ FleetFlea</span>
      </div>
    </div>

  <div class="error-banner" id="error-banner" style="display:none"></div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div id="loading-message">Fetching fleet data...</div>
  </div>

  <div id="content" style="display:none">

    <div class="kpi-row">
      <div class="kpi-card green">
        <div class="kpi-label">üåç CO‚ÇÇ emitted</div>
        <div class="kpi-value" id="kpi-co2">‚Äî<span class="unit"> t</span></div>
        <div class="kpi-desc">Tailpipe ‚Äî engine data when available</div>
        <div class="kpi-insight" id="kpi-co2-insight"></div>
      </div>

      <div class="kpi-card orange">
        <div class="kpi-label">‚è±Ô∏è Idle fuel wasted</div>
        <div class="kpi-value" id="kpi-idle">‚Äî<span class="unit"> L</span></div>
        <div class="kpi-desc">Engine running ‚Äî vehicle stationary</div>
        <div class="kpi-insight" id="kpi-idle-insight"></div>
      </div>

      <div class="kpi-card blue">
        <div class="kpi-label">‚ö° EV-ready vehicles</div>
        <div class="kpi-value" id="kpi-ev">‚Äî<span class="unit"></span></div>
        <div class="kpi-desc">Score ‚â• 72 ‚Äî good fit for current pattern</div>
        <div class="kpi-insight" id="kpi-ev-insight"></div>
      </div>
    </div>

    <div class="section-card">
      <div class="section-header">
        <span class="section-title">Top 10 Idle Offenders</span>
        <span class="pill pill-orange" id="idle-fleet-pct"></span>
      </div>
      <div class="section-body">
        <div class="insight-box" id="idle-highlight"></div>
        <table>
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Idle time</th>
              <th>% engine-on</th>
              <th>Idle % of fuel</th>
              <th>Fuel wasted</th>
              <th>CO‚ÇÇ wasted</th>
              <th>Status</th>
              <th>üìä</th>
            </tr>
          </thead>
          <tbody id="idle-tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="section-card">
      <div class="section-header">
        <span class="section-title">Top EV Transition Candidates</span>
        <span class="pill pill-blue" id="ev-saving-pill"></span>
      </div>
      <div class="section-body">
        <div class="insight-box" id="ev-highlight"></div>
        <table>
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Avg daily km</th>
              <th>Trips / day</th>
              <th>Idle %</th>
              <th>Harsh penalty</th>
              <th>EV Score</th>
              <th>Recommendation</th>
            </tr>
          </thead>
          <tbody id="ev-tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      GreenFleet IQ v1.8 ‚Ä¢ FleetFlea ‚Ä¢ Data: MyGeotab Trip API ‚Ä¢ Feb 2026
    </div>

  </div>

  <!-- Modal -->
  <div id="vehicle-modal" class="modal" style="display:none">
    <div class="modal-content">
      <button class="modal-close-btn" id="modal-close">√ó</button>
      <div class="modal-vehicle-title" id="modal-vehicle-name"></div>
      <div class="modal-subtitle">Daily idle breakdown ‚Äî trends over selected period</div>
      <div class="chart-wrap"><canvas id="chart-combined"></canvas></div>
    </div>
  </div>

<!-- MAP TAB -->
  <div id="map" class="tab-content" style="display:none; height: calc(100vh - 120px);">
    <div class="map-header">
      <h2>EV Charging Readiness Map</h2>
      <div class="map-filters">
        <button class="pill pill-yellow" id="filter-long">30‚Äì60 min stops</button>
        <button class="pill pill-purple" id="filter-night">Night stops (>4h)</button>
        <button class="pill pill-green" id="filter-ev">EV Chargers</button>
        <button class="pill" id="filter-reset">Show All</button>
      </div>
    </div>
    <div id="leaflet-map" style="height: 100%; width: 100%;"></div>
  </div>

<script>
(function() {
"use strict";

// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CO2_KG_PER_L_GASOLINE = 2.32;
const CO2_KG_PER_L_DIESEL   = 2.697;
const FUEL_L_PER_100KM      = 10.0;
const IDLE_L_PER_HOUR       = 0.80;
const RESULTS_LIMIT         = 50000;


let currentCharts = [];

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt = (n, dec = 0) => isNaN(n) || n == null ? "‚Äî" : Number(n).toLocaleString(undefined, {maximumFractionDigits: dec});

function parseDur(d) {
  if (!d) return 0;
  if (typeof d === "number") return d;
  if (d.totalSeconds != null) return d.totalSeconds;
  if (d.ticks != null) return d.ticks / 1e7;
  if (typeof d === "string") {
    const p = d.split(":");
    if (p.length === 3) return (+p[0]) * 3600 + (+p[1]) * 60 + +p[2];
  }
  return 0;
}

function showError(msg) {
  const el = document.getElementById("error-banner");
  el.textContent = "‚ö†Ô∏è " + msg;
  el.style.display = "block";
  document.getElementById("loading").style.display = "none";
}

function getEmissionFactor(device) {
  const type = (device?.engineType || "").toLowerCase();
  if (type.includes("diesel")) return CO2_KG_PER_L_DIESEL;
  return CO2_KG_PER_L_GASOLINE;
}

function evScore(avgKm, idlePct, tripsDay) {
  let s = 10;
  let rangePts = 42 * Math.max(0, 1 - Math.max(0, avgKm - 250) / 130);
  s += rangePts;
  s += Math.min(30, idlePct * 0.30);
  s += Math.min(22, tripsDay * 6.5);
  if (avgKm > 180 && tripsDay > 6 && idlePct > 12) s += 10;
  return Math.min(100, Math.round(s));
}

function verdict(score) {
  if (score >= 72) return ["Strong EV fit", "pill-green"];
  if (score >= 55) return ["Good candidate", "pill-blue"];
  if (score >= 38) return ["Possible", "pill-orange"];
  return ["Low priority", "pill-red"];
}

function progressBar(pct, color) {
  return `<div class="progress-wrap">
    <div class="progress-bg"><div class="progress-fill" style="width:${Math.min(pct,100)}%;background:${color}"></div></div>
    <span class="progress-label">${fmt(pct,0)}%</span>
  </div>`;
}

// ‚îÄ‚îÄ Main logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
geotab.addin["greenfleet-iq"] = function () {
  let api;
  let days = 30;
  let dailyDataMap = {};
  let vehicles = [];

  function run(apiRef, selectedDays) {
    api = apiRef;
    days = selectedDays || days;
    dailyDataMap = {};
    vehicles = [];

    const now = new Date();
    const from = new Date(now - days * 86400000);

    document.getElementById("page-subtitle").textContent = `Fuel waste ¬∑ Idle inefficiency ¬∑ EV readiness ¬∑ Last ${days} days`;
    document.getElementById("loading-message").textContent = `Fetching fleet data for last ${days} days...`;
    document.getElementById("content").style.display = "none";
    document.getElementById("loading").style.display = "flex";

    api.call("Get", { typeName: "Device" }, devices => {
      const nameMap = {};
      devices.forEach(d => { nameMap[d.id] = d.name || d.serialNumber || d.id; });

      api.call("Get", {
        typeName: "Trip",
        search: { fromDate: from.toISOString(), toDate: now.toISOString() },
        resultsLimit: RESULTS_LIMIT
      }, trips => {

        // ExceptionEvent removed: rule is a reference object (id only),
        // harsh penalty lookup needs a separate Rule fetch ‚Äî not worth the latency.
        render(trips, nameMap, devices);

      }, err => showError("Trips failed: " + err));

    }, err => showError("Devices failed: " + err));
  }

  function render(trips, nameMap, devices) {
    const deviceMap = {};
    devices.forEach(d => deviceMap[d.id] = d);

    let maxRawDist = 0;
    trips.forEach(t => { if ((t.distance||0) > maxRawDist) maxRawDist = t.distance||0; });
    const kmFactor = maxRawDist > 5000 ? 0.001 : 1;

    const byVehicle = {};

    trips.forEach(t => {
      const id = t.device?.id;
      if (!id) return;

      if (!byVehicle[id]) {
        byVehicle[id] = {
          id, name: nameMap[id] || id,
          distKm: 0, trips: 0,
          driveSec: 0, idleSec: 0,
          days: new Set(),
          fuelUsedL: 0,
        };
      }
      const v = byVehicle[id];

      v.distKm   += (t.distance || 0) * kmFactor;
      v.trips    += 1;
      v.days.add(t.start?.slice(0,10) || "");

      v.driveSec += parseDur(t.drivingDuration);
      v.idleSec  += parseDur(t.idlingDuration);

      if (t.fuelUsed?.value && !isNaN(t.fuelUsed.value)) {
        v.fuelUsedL += Number(t.fuelUsed.value);
      }

      // Daily aggregation
      const day = t.start?.slice(0,10) || '';
      if (!dailyDataMap[id]) dailyDataMap[id] = {};
      if (!dailyDataMap[id][day]) dailyDataMap[id][day] = {idleSec:0, driveSec:0, idleFuelL:0, totalFuelL:0};

      const dd = dailyDataMap[id][day];
      dd.idleSec += parseDur(t.idlingDuration);
      dd.driveSec += parseDur(t.drivingDuration);

      let drivingFuelL = t.fuelUsed?.value && !isNaN(t.fuelUsed.value) ? Number(t.fuelUsed.value) : ((t.distance||0) * kmFactor * (FUEL_L_PER_100KM / 100));
      dd.idleFuelL += (parseDur(t.idlingDuration) / 3600) * IDLE_L_PER_HOUR;
      dd.totalFuelL += drivingFuelL;
    });

    vehicles = Object.values(byVehicle).filter(v => v.trips > 0);

    vehicles.forEach(v => {
      v.idleHrs    = v.idleSec / 3600;
      v.driveHrs   = v.driveSec / 3600;
      v.totalHrs   = v.idleHrs + v.driveHrs;
      v.idlePct    = v.totalHrs > 0 ? v.idleSec / (v.driveSec + v.idleSec) * 100 : 0;
      v.activeDays = Math.max(v.days.size, 1);
      v.avgDailyKm = v.distKm / v.activeDays;
      v.tripsDay   = v.trips / v.activeDays;

      let drivingFuelL = v.fuelUsedL > 0.1 ? v.fuelUsedL : v.distKm * (FUEL_L_PER_100KM / 100);
      v.idleFuel   = v.idleHrs * IDLE_L_PER_HOUR;
      v.totalFuel  = drivingFuelL + v.idleFuel;

      v.harshPenaltyPct = 0;

      const co2Factor = getEmissionFactor(deviceMap[v.id]);
      v.co2Kg      = v.totalFuel * co2Factor;
      v.co2IdleKg  = v.idleFuel * co2Factor;

      v.idleFuelPct = v.totalFuel > 0 ? v.idleFuel / v.totalFuel * 100 : 0;

      v.evScore    = evScore(v.avgDailyKm, v.idlePct, v.tripsDay);
    });

    const totalCO2     = vehicles.reduce((s,v)=>s+v.co2Kg,     0) / 1000;
    const totalIdleL   = vehicles.reduce((s,v)=>s+v.idleFuel,  0);
    const totalFuel    = vehicles.reduce((s,v)=>s+v.totalFuel, 0);
    const fleetIdlePct = totalFuel > 0 ? totalIdleL / totalFuel * 100 : 0;
    const evReady      = vehicles.filter(v => v.evScore >= 72);
    const evCount      = evReady.length;

    document.getElementById("kpi-co2").innerHTML = fmt(totalCO2, totalCO2<10?1:0) + '<span class="unit"> t</span>';
    document.getElementById("kpi-co2-insight").innerHTML = `‚âà <strong>${fmt(totalCO2 * 1000 / 0.115, 0)}</strong> km driven by avg passenger car`;

    document.getElementById("kpi-idle").innerHTML = fmt(totalIdleL, 0) + '<span class="unit"> L</span>';
    document.getElementById("kpi-idle-insight").innerHTML = `<strong>${fmt(fleetIdlePct,1)}%</strong> of total fuel wasted on idling`;

    document.getElementById("kpi-ev").innerHTML = `${evCount}<span class="unit"> / ${vehicles.length}</span>`;
    const potYearCO2 = evReady.reduce((s,v)=>s+v.co2Kg,0) / 1000 * 12 * 0.84;
    document.getElementById("kpi-ev-insight").innerHTML = `Switching could avoid <strong>${fmt(potYearCO2,0)} t CO‚ÇÇ/year</strong>`;

    const worstIdle = [...vehicles].sort((a,b)=>b.idleHrs - a.idleHrs);

    document.getElementById("idle-fleet-pct").textContent = fmt(fleetIdlePct,1) + "% fleet idle";

    document.getElementById("idle-highlight").innerHTML =
      `<span class="icon">üí°</span> Fixing idle on the <strong>top 3</strong> alone would save ` +
      `<strong>${fmt(worstIdle.slice(0,3).reduce((s,v)=>s+v.idleFuel,0),0)} L</strong> fuel and ` +
      `<strong>${fmt(worstIdle.slice(0,3).reduce((s,v)=>s+v.co2IdleKg,0)/1000,1)} t CO‚ÇÇ</strong> this period.`;

    document.getElementById("idle-tbody").innerHTML = worstIdle.slice(0,10).map(v => {
      const color = v.idlePct > 28 ? "#D13438" : v.idlePct > 16 ? "#FFB900" : "#107C10";
      const cls   = v.idlePct > 28 ? "pill-red" : v.idlePct > 16 ? "pill-orange" : "pill-green";
      const txt   = v.idlePct > 28 ? "Critical" : v.idlePct > 16 ? "High" : "Normal";
      return `<tr>
        <td><strong>${v.name}</strong></td>
        <td>${fmt(v.idleHrs,1)} h</td>
        <td class="idle-bar-cell">${progressBar(v.idlePct, color)}</td>
        <td>${fmt(v.idleFuelPct,1)}%</td>
        <td>${fmt(v.idleFuel,0)} L</td>
        <td>${fmt(v.co2IdleKg,0)} kg</td>
        <td><span class="pill ${cls}">${txt}</span></td>
        <td><button class="detail-btn" data-id="${v.id}">üìä</button></td>
      </tr>`;
    }).join("");

    const evSorted = [...vehicles].sort((a,b)=>b.evScore - a.evScore).slice(0,10);
    document.getElementById("ev-tbody").innerHTML = evSorted.map(v => {
      const [txt, cls] = verdict(v.evScore);
      const color = v.evScore >= 72 ? "#107C10" : v.evScore >= 55 ? "#0078D4" : v.evScore >= 38 ? "#FFB900" : "#D13438";
      return `<tr>
        <td><strong>${v.name}</strong></td>
        <td>${fmt(v.avgDailyKm,0)} km</td>
        <td>${fmt(v.tripsDay,1)}</td>
        <td>${fmt(v.idlePct,1)}%</td>
        <td>${v.harshPenaltyPct > 0.1 ? fmt(v.harshPenaltyPct,1) + "%" : "‚Äî"}</td>
        <td>${progressBar(v.evScore, color)}</td>
        <td><span class="pill ${cls}">${txt}</span></td>
      </tr>`;
    }).join("");

    // EV insight
    const avgKmReady = evReady.length ? evReady.reduce((s,v)=>s+v.avgDailyKm,0)/evReady.length : 0;
    document.getElementById("ev-highlight").innerHTML =
      `<span class="icon">‚ö°</span>
      <strong>${evCount} vehicle${evCount===1?"":"s"}</strong> look like strong EV candidates.<br>
      Avg <strong>${fmt(avgKmReady,0)} km/day</strong> ‚Äî well inside typical EV range.<br>
      High idle % makes them especially attractive for electrification.`;

    document.getElementById("ev-saving-pill").textContent = `~${fmt(potYearCO2,0)} t CO‚ÇÇ/yr avoided if switched`;

    // –ì—Ä–∞—Ñ–∏–∫–∏ –≤ –º–æ–¥–∞–ª–∫–µ
    document.querySelectorAll('.detail-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const vehicle = vehicles.find(v => v.id === id);
        if (!vehicle) return;

        document.getElementById('modal-vehicle-name').textContent = vehicle.name;

        const daysArr = Object.keys(dailyDataMap[id] || {}).sort();

        const engineOnData = daysArr.map(d => {
          const dd = dailyDataMap[id][d];
          return dd.idleSec / (dd.idleSec + dd.driveSec) * 100 || 0;
        });

        const idleFuelPctData = daysArr.map(d => {
          const dd = dailyDataMap[id][d];
          return dd.totalFuelL > 0 ? dd.idleFuelL / dd.totalFuelL * 100 : 0;
        });

        const fuelWastedData = daysArr.map(d => dailyDataMap[id][d].idleFuelL);

        currentCharts.forEach(c => c && c.destroy());
        currentCharts = [];

        currentCharts.push(new Chart(document.getElementById('chart-combined'), {
          type: 'line',
          data: {
            labels: daysArr,
            datasets: [
              {
                label: 'Idle % of engine-on time',
                data: engineOnData,
                borderColor: '#FFB900',
                backgroundColor: 'rgba(255,185,0,.10)',
                fill: true, tension: 0.35,
                pointRadius: 3, pointHoverRadius: 5,
                yAxisID: 'yPct'
              },
              {
                label: 'Idle fuel % of total fuel',
                data: idleFuelPctData,
                borderColor: '#D13438',
                backgroundColor: 'rgba(209,52,56,.07)',
                fill: true, tension: 0.35,
                pointRadius: 3, pointHoverRadius: 5,
                yAxisID: 'yPct'
              },
              {
                label: 'Idle fuel wasted (L)',
                data: fuelWastedData,
                borderColor: '#0078D4',
                backgroundColor: 'rgba(0,120,212,.07)',
                fill: false, tension: 0.35,
                pointRadius: 3, pointHoverRadius: 5,
                borderDash: [5, 3],
                yAxisID: 'yL'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: {
                display: true,
                position: 'bottom',
                labels: {
                  font: { family: "'Segoe UI', sans-serif", size: 12 },
                  color: '#605E5C',
                  padding: 20,
                  usePointStyle: true,
                  pointStyleWidth: 14
                }
              },
              tooltip: {
                backgroundColor: '#fff',
                borderColor: '#C8C6C4',
                borderWidth: 1,
                titleColor: '#201F1E',
                bodyColor: '#605E5C',
                padding: 10,
                callbacks: {
                  label: ctx => {
                    const v = ctx.parsed.y;
                    if (ctx.datasetIndex < 2) return ` ${ctx.dataset.label}: ${v.toFixed(1)}%`;
                    return ` ${ctx.dataset.label}: ${v.toFixed(1)} L`;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { color: '#EDEBE9' },
                ticks: { font: { size: 11 }, color: '#605E5C', maxRotation: 45 }
              },
              yPct: {
                type: 'linear', position: 'left',
                grid: { color: '#EDEBE9' },
                ticks: { font: { size: 11 }, color: '#605E5C', callback: v => v + '%' },
                title: { display: true, text: '% of time / fuel', font: { size: 11 }, color: '#605E5C' }
              },
              yL: {
                type: 'linear', position: 'right',
                grid: { drawOnChartArea: false },
                ticks: { font: { size: 11 }, color: '#0078D4', callback: v => v + ' L' },
                title: { display: true, text: 'Litres wasted', font: { size: 11 }, color: '#0078D4' }
              }
            }
          }
        }));

        document.getElementById('vehicle-modal').style.display = 'flex';
      });
    });

    document.getElementById('modal-close').addEventListener('click', () => {
      document.getElementById('vehicle-modal').style.display = 'none';
    });

    document.getElementById("loading").style.display = "none";
    document.getElementById("content").style.display = "block";

    function updateMapMarkers(trips) {
  if (!longStopLayer || !nightStopLayer) return;

  longStopLayer.clearLayers();
  nightStopLayer.clearLayers();

  trips.forEach(t => {
    if (!t.stopPoint) return;
    const durMin = parseDur(t.stopDuration) / 60;

    if (durMin >= 30 && durMin <= 60) {
      L.marker([t.stopPoint.y, t.stopPoint.x], {icon: L.divIcon({className: 'stop-marker long', html: 'üü°', iconSize: [24,24]})})
        .bindPopup(`<b>30‚Äì60 min stop</b><br>${t.start.slice(0,16)}<br>Duration: ${durMin.toFixed(0)} min`)
        .addTo(longStopLayer);
    }

    if (durMin > 240) { // >4 hours
      const hour = parseInt(t.start.slice(11,13));
      if (hour >= 22 || hour <= 6) {
        L.marker([t.stopPoint.y, t.stopPoint.x], {icon: L.divIcon({className: 'stop-marker night', html: 'üåô', iconSize: [24,24]})})
          .bindPopup(`<b>Night stop</b><br>${t.start.slice(0,16)}<br>Duration: ${(durMin/60).toFixed(1)} h`)
          .addTo(nightStopLayer);
      }
    }
  });
}
allStops = trips;
if (map) updateMapMarkers(allStops);
  }

let map, longStopLayer, nightStopLayer, evLayer;
let allStops = [];

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.getElementById(btn.dataset.tab).style.display = 'block';

    if (btn.dataset.tab === 'map' && !map) initMap();
  });
});

function initMap() {
  map = L.map('leaflet-map').setView([25.76, -80.19], 10); // Miami center

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  longStopLayer = L.layerGroup().addTo(map);
  nightStopLayer = L.layerGroup().addTo(map);
  evLayer = L.layerGroup().addTo(map);

  if (allStops.length) {
    updateMapMarkers(allStops);
  }

  // Fetch EV chargers from NREL (free API - replace DEMO_KEY after registration at developer.nrel.gov)
  fetch('https://developer.nrel.gov/api/alt-fuel-stations/v1.json?api_key=DEMO_KEY&fuel_type=ELEC&state=FL&limit=200')
    .then(r => r.json())
    .then(data => {
      data.fuel_stations.forEach(s => {
        if (s.latitude && s.longitude) {
          L.marker([s.latitude, s.longitude], {icon: L.divIcon({className: 'ev-marker', html: '‚ö°', iconSize: [30,30]})})
            .bindPopup(`<b>${s.station_name}</b><br>${s.street_address}<br>${s.ev_dc_fast_num || 0} DC Fast | ${s.ev_level2_evse_num || 0} Level 2`)
            .addTo(evLayer);
        }
      });
    });

  document.getElementById('filter-long').addEventListener('click', () => {
    map.addLayer(longStopLayer);
    map.removeLayer(nightStopLayer);
    map.removeLayer(evLayer);
  });

  document.getElementById('filter-night').addEventListener('click', () => {
    map.removeLayer(longStopLayer);
    map.addLayer(nightStopLayer);
    map.removeLayer(evLayer);
  });

  document.getElementById('filter-ev').addEventListener('click', () => {
    map.removeLayer(longStopLayer);
    map.removeLayer(nightStopLayer);
    map.addLayer(evLayer);
  });

  document.getElementById('filter-reset').addEventListener('click', () => {
    map.addLayer(longStopLayer);
    map.addLayer(nightStopLayer);
    map.addLayer(evLayer);
  });
}

  return {
    initialize: function (api, state, callback) {
      api.getSession(s => {
        document.getElementById("db-label").textContent = s.database || "‚Äî";
      });

      document.getElementById("range-select").addEventListener("change", function (e) {
        const selectedDays = parseInt(e.target.value);
        run(api, selectedDays);
      });

      run(api);
      callback();
    },
    focus:   function (api, state) { /* no-op ‚Äî data loaded on initialize */ },
    blur:    () => {}
  };
};
})();
</script>
</body>
</html>
