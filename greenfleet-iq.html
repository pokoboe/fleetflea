<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>GreenFleet IQ</title>
  <style>
    /* â”€â”€ Zenith design tokens â”€â”€ */
    :root {
      --z-blue:      #0078D4;
      --z-blue-dark: #005A9E;
      --z-green:     #107C10;
      --z-warning:   #FFB900;
      --z-red:       #D13438;
      --z-neutral-900: #201F1E;
      --z-neutral-600: #605E5C;
      --z-neutral-300: #C8C6C4;
      --z-neutral-100: #EDEBE9;
      --z-white:     #FFFFFF;
      --z-font: 'Segoe UI', -apple-system, sans-serif;
      --z-radius: 4px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--z-font);
      font-size: 14px;
      color: var(--z-neutral-900);
      background: var(--z-neutral-100);
      padding: 24px;
    }

    /* â”€â”€ Page header â”€â”€ */
    .page-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .page-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--z-neutral-900);
    }
    .page-subtitle {
      font-size: 12px;
      color: var(--z-neutral-600);
      margin-top: 2px;
    }
    .db-label {
      font-size: 12px;
      color: var(--z-neutral-600);
      background: var(--z-white);
      border: 1px solid var(--z-neutral-300);
      border-radius: var(--z-radius);
      padding: 4px 10px;
    }

    /* â”€â”€ Loading â”€â”€ */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 24px;
      gap: 16px;
      color: var(--z-neutral-600);
      font-size: 14px;
    }
    .spinner {
      width: 28px; height: 28px;
      border: 3px solid var(--z-neutral-300);
      border-top-color: var(--z-blue);
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Error banner â”€â”€ */
    .error-banner {
      background: #FDE7E9;
      border-left: 4px solid var(--z-red);
      border-radius: var(--z-radius);
      padding: 14px 16px;
      color: var(--z-red);
      font-size: 13px;
      margin-bottom: 16px;
      display: none;
    }

    /* â”€â”€ KPI cards row â”€â”€ */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: var(--z-white);
      border: 1px solid var(--z-neutral-300);
      border-radius: var(--z-radius);
      padding: 20px 24px;
      border-top: 3px solid var(--z-neutral-300);
    }
    .kpi-card.green  { border-top-color: var(--z-green); }
    .kpi-card.orange { border-top-color: var(--z-warning); }
    .kpi-card.blue   { border-top-color: var(--z-blue); }

    .kpi-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--z-neutral-600);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .kpi-value {
      font-size: 32px;
      font-weight: 700;
      line-height: 1;
      color: var(--z-neutral-900);
      margin-bottom: 4px;
    }
    .kpi-value .unit {
      font-size: 16px;
      font-weight: 400;
      color: var(--z-neutral-600);
      margin-left: 2px;
    }
    .kpi-desc {
      font-size: 12px;
      color: var(--z-neutral-600);
      line-height: 1.4;
      margin-top: 4px;
    }
    .kpi-insight {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--z-neutral-100);
      font-size: 12px;
      color: var(--z-neutral-600);
    }
    .kpi-insight strong {
      color: var(--z-neutral-900);
    }

    /* â”€â”€ Section card â”€â”€ */
    .section-card {
      background: var(--z-white);
      border: 1px solid var(--z-neutral-300);
      border-radius: var(--z-radius);
      margin-bottom: 16px;
    }
    .section-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--z-neutral-100);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--z-neutral-900);
    }
    .section-body {
      padding: 0;
    }

    /* â”€â”€ Table â”€â”€ */
    table { width: 100%; border-collapse: collapse; }
    th {
      text-align: left;
      padding: 10px 24px;
      font-size: 11px;
      font-weight: 600;
      color: var(--z-neutral-600);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--z-neutral-100);
      border-bottom: 1px solid var(--z-neutral-300);
    }
    td {
      padding: 12px 24px;
      font-size: 13px;
      border-bottom: 1px solid var(--z-neutral-100);
      color: var(--z-neutral-900);
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #F3F2F1; }

    /* â”€â”€ Pill badges â”€â”€ */
    .pill {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .pill-green  { background: #DFF6DD; color: #107C10; }
    .pill-orange { background: #FFF4CE; color: #7A4F00; }
    .pill-red    { background: #FDE7E9; color: #D13438; }
    .pill-blue   { background: #EFF6FC; color: #0078D4; }

    /* â”€â”€ Progress bar â”€â”€ */
    .progress-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .progress-bg {
      flex: 1;
      height: 6px;
      background: var(--z-neutral-100);
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 3px;
    }
    .progress-label {
      font-size: 12px;
      color: var(--z-neutral-600);
      min-width: 32px;
      text-align: right;
    }

    /* â”€â”€ Highlight box â”€â”€ */
    .highlight-box {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: #EFF6FC;
      border-radius: var(--z-radius);
      border: 1px solid #C7E0F4;
      margin: 16px 24px;
      font-size: 13px;
      color: var(--z-neutral-900);
    }
    .highlight-box .icon { font-size: 20px; }

    /* â”€â”€ Idle bar inline â”€â”€ */
    .idle-bar-cell { min-width: 120px; }

    @media (max-width: 700px) {
      .kpi-row { grid-template-columns: 1fr; }
      body { padding: 16px; }
    }
  </style>
</head>
<body>

  <!-- Page header -->
  <div class="page-header">
    <div>
      <div class="page-title">ğŸŒ¿ GreenFleet IQ</div>
      <div class="page-subtitle">Fuel waste &amp; EV readiness Â· Last 7 days</div>
    </div>
    <span class="db-label" id="db-label">Loading...</span>
  </div>

  <!-- Error -->
  <div class="error-banner" id="error-banner"></div>

  <!-- Loading -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <span>Fetching fleet data...</span>
  </div>

  <!-- Content (hidden until loaded) -->
  <div id="content" style="display:none">

    <!-- KPI row -->
    <div class="kpi-row">

      <div class="kpi-card green">
        <div class="kpi-label">ğŸŒ COâ‚‚ Emitted</div>
        <div class="kpi-value" id="kpi-co2">â€”<span class="unit">t</span></div>
        <div class="kpi-desc">Estimated from real trip distances</div>
        <div class="kpi-insight" id="kpi-co2-insight"></div>
      </div>

      <div class="kpi-card orange">
        <div class="kpi-label">â±ï¸ Idle Fuel Wasted</div>
        <div class="kpi-value" id="kpi-idle">â€”<span class="unit">L</span></div>
        <div class="kpi-desc">Engine on, not moving</div>
        <div class="kpi-insight" id="kpi-idle-insight"></div>
      </div>

      <div class="kpi-card blue">
        <div class="kpi-label">âš¡ EV-Ready Vehicles</div>
        <div class="kpi-value" id="kpi-ev">â€”<span class="unit"></span></div>
        <div class="kpi-desc">Score â‰¥ 70: range fits, high idle, short trips</div>
        <div class="kpi-insight" id="kpi-ev-insight"></div>
      </div>

    </div>

    <!-- Idle table -->
    <div class="section-card">
      <div class="section-header">
        <span class="section-title">Idle Time â€” Top 10 Worst Offenders</span>
        <span class="pill pill-orange" id="idle-fleet-pct"></span>
      </div>
      <div class="section-body">
        <div class="highlight-box" id="idle-highlight"></div>
        <table>
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Idle Time</th>
              <th>% of Engine-On</th>
              <th>Fuel Wasted</th>
              <th>COâ‚‚ Wasted</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="idle-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- EV readiness table -->
    <div class="section-card">
      <div class="section-header">
        <span class="section-title">EV Readiness â€” Top Candidates</span>
        <span class="pill pill-blue" id="ev-saving-pill"></span>
      </div>
      <div class="section-body">
        <div class="highlight-box" id="ev-highlight"></div>
        <table>
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Avg Daily km</th>
              <th>Trips / Day</th>
              <th>Idle %</th>
              <th>EV Score</th>
              <th>Verdict</th>
            </tr>
          </thead>
          <tbody id="ev-tbody"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /content -->

<script>
"use strict";

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var CO2_KG_PER_LITRE = 2.31;   // gasoline
var FUEL_L_PER_KM    = 0.10;   // 10 L / 100 km fleet avg
var IDLE_FUEL_L_HR   = 0.8;    // litres / hour idling
var DAYS             = 7;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n, dec) {
  if (n == null || isNaN(n)) return "â€”";
  return Number(n).toLocaleString(undefined, { maximumFractionDigits: dec != null ? dec : 0 });
}
function showError(msg) {
  var el = document.getElementById("error-banner");
  el.textContent = "âš ï¸ " + msg;
  el.style.display = "block";
  document.getElementById("loading").style.display = "none";
}
function evScore(avgDailyKm, idlePct, tripsPerDay) {
  var s = 0;
  // Range fit: â‰¤150 km = full 40pts, linear above
  s += Math.max(0, Math.min(40, (150 - avgDailyKm) / 150 * 40));
  // High idle = EV shines (no idle waste)
  s += Math.min(30, idlePct / 100 * 30);
  // Multiple short trips per day
  s += Math.min(20, tripsPerDay * 7);
  // Base
  s += 10;
  return Math.min(100, Math.round(s));
}
function evVerdict(score) {
  if (score >= 70) return ["EV Ready", "pill-green"];
  if (score >= 50) return ["Good Fit", "pill-blue"];
  if (score >= 35) return ["Consider", "pill-orange"];
  return ["Not Yet", "pill-red"];
}
function progressBar(pct, color) {
  return '<div class="progress-wrap">' +
    '<div class="progress-bg"><div class="progress-fill" style="width:' +
    Math.min(pct, 100) + '%;background:' + color + '"></div></div>' +
    '<span class="progress-label">' + fmt(pct, 0) + '%</span></div>';
}

// â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
geotab.addin["greenfleet-iq"] = function () {
  var apiRef;

  function run(api) {
    apiRef = api;
    var now   = new Date();
    var from  = new Date(now - DAYS * 24 * 3600 * 1000);

    // Parallel: devices + trips
    api.call("Get", { typeName: "Device" }, function (devices) {

      var nameMap = {};
      devices.forEach(function (d) { nameMap[d.id] = d.name; });

      api.call("Get", {
        typeName: "Trip",
        search: {
          fromDate: from.toISOString(),
          toDate:   now.toISOString()
        },
        resultsLimit: 50000
      }, function (trips) {

        render(trips, nameMap);

      }, function (err) { showError("Failed to load trips: " + err); });

    }, function (err) { showError("Failed to load devices: " + err); });
  }

  function render(trips, nameMap) {
    // â”€â”€ Aggregate by vehicle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var byVehicle = {};

    trips.forEach(function (t) {
      var id = t.device && t.device.id;
      if (!id) return;
      if (!byVehicle[id]) {
        byVehicle[id] = {
          id: id,
          name: nameMap[id] || id,
          distKm: 0, tripCount: 0,
          driveSec: 0, idleSec: 0,
          days: {}
        };
      }
      var v = byVehicle[id];
      // Trip.distance is in METERS
      v.distKm    += (t.distance || 0) / 1000;
      v.tripCount += 1;
      // Duration fields: .ticks = 100-nanosecond intervals
      if (t.drivingDuration && t.drivingDuration.ticks)
        v.driveSec += t.drivingDuration.ticks / 1e7;
      if (t.idlingDuration && t.idlingDuration.ticks)
        v.idleSec  += t.idlingDuration.ticks / 1e7;
      if (t.start) v.days[t.start.substring(0, 10)] = 1;
    });

    var vehicles = Object.values(byVehicle).filter(function (v) {
      return v.tripCount > 0;
    });

    // â”€â”€ Derived metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    vehicles.forEach(function (v) {
      v.idleHrs     = v.idleSec / 3600;
      v.driveHrs    = v.driveSec / 3600;
      v.totalHrs    = v.idleHrs + v.driveHrs;
      v.idlePct     = v.totalHrs > 0 ? v.idleSec / (v.driveSec + v.idleSec) * 100 : 0;
      v.activeDays  = Math.max(Object.keys(v.days).length, 1);
      v.avgDailyKm  = v.distKm / v.activeDays;
      v.tripsPerDay = v.tripCount / v.activeDays;
      v.idleFuelL   = v.idleHrs * IDLE_FUEL_L_HR;
      v.driveFuelL  = v.distKm  * FUEL_L_PER_KM;
      v.totalFuelL  = v.driveFuelL + v.idleFuelL;
      v.co2Kg       = v.totalFuelL * CO2_KG_PER_LITRE;
      v.co2IdleKg   = v.idleFuelL  * CO2_KG_PER_LITRE;
      v.evScore     = evScore(v.avgDailyKm, v.idlePct, v.tripsPerDay);
    });

    // â”€â”€ Fleet totals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var totalCO2Kg    = vehicles.reduce(function (s, v) { return s + v.co2Kg; }, 0);
    var totalIdleFuel = vehicles.reduce(function (s, v) { return s + v.idleFuelL; }, 0);
    var totalFuel     = vehicles.reduce(function (s, v) { return s + v.totalFuelL; }, 0);
    var fleetIdlePct  = totalFuel > 0 ? totalIdleFuel / totalFuel * 100 : 0;
    var evReady       = vehicles.filter(function (v) { return v.evScore >= 70; });

    // â”€â”€ KPI cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var co2T = totalCO2Kg / 1000;
    document.getElementById("kpi-co2").innerHTML =
      fmt(co2T, co2T < 10 ? 1 : 0) + '<span class="unit"> t</span>';
    document.getElementById("kpi-co2-insight").innerHTML =
      'Equiv. <strong>' + fmt(co2T * 1000 / 0.12, 0) + ' km</strong> driven by avg car';

    document.getElementById("kpi-idle").innerHTML =
      fmt(totalIdleFuel, 0) + '<span class="unit"> L</span>';
    document.getElementById("kpi-idle-insight").innerHTML =
      '<strong>' + fmt(fleetIdlePct, 1) + '%</strong> of all fuel burned â€” engine on, going nowhere';

    var evCount = evReady.length;
    document.getElementById("kpi-ev").innerHTML =
      evCount + '<span class="unit"> / ' + vehicles.length + '</span>';
    var potentialCO2T = evReady.reduce(function (s, v) { return s + v.co2Kg; }, 0) / 1000 * 12 * 0.85;
    document.getElementById("kpi-ev-insight").innerHTML =
      'Could avoid <strong>' + fmt(potentialCO2T, 0) + ' t COâ‚‚/year</strong> if switched to EV';

    // â”€â”€ Idle table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("idle-fleet-pct").textContent =
      fmt(fleetIdlePct, 1) + "% fleet idle";

    var worstIdle = vehicles.slice().sort(function (a, b) { return b.idleHrs - a.idleHrs; });
    var topIdle   = worstIdle[0];
    document.getElementById("idle-highlight").innerHTML =
      '<span class="icon">ğŸ’¡</span>' +
      'Eliminating idle on the <strong>top 3 offenders</strong> alone would save ' +
      '<strong>' + fmt(worstIdle.slice(0,3).reduce(function(s,v){return s+v.idleFuelL;},0), 0) +
      ' L of fuel</strong> and <strong>' +
      fmt(worstIdle.slice(0,3).reduce(function(s,v){return s+v.co2IdleKg;},0)/1000, 2) +
      ' t COâ‚‚</strong> this week.';

    var idleTop10 = worstIdle.slice(0, 10);
    document.getElementById("idle-tbody").innerHTML = idleTop10.map(function (v, i) {
      var pctColor = v.idlePct > 25 ? "#D13438" : v.idlePct > 15 ? "#FFB900" : "#107C10";
      var statusCls = v.idlePct > 25 ? "pill-red" : v.idlePct > 15 ? "pill-orange" : "pill-green";
      var statusTxt = v.idlePct > 25 ? "Critical" : v.idlePct > 15 ? "High" : "Normal";
      return "<tr>" +
        "<td><strong>" + v.name + "</strong></td>" +
        "<td>" + fmt(v.idleHrs, 1) + " hrs</td>" +
        "<td class='idle-bar-cell'>" + progressBar(v.idlePct, pctColor) + "</td>" +
        "<td>" + fmt(v.idleFuelL, 0) + " L</td>" +
        "<td>" + fmt(v.co2IdleKg, 0) + " kg</td>" +
        "<td><span class='pill " + statusCls + "'>" + statusTxt + "</span></td>" +
        "</tr>";
    }).join("");

    // â”€â”€ EV table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var annualSavingT = evReady.reduce(function (s, v) { return s + v.co2Kg; }, 0) / 1000 * 12 * 0.85;
    document.getElementById("ev-saving-pill").textContent =
      "~" + fmt(annualSavingT, 0) + " t COâ‚‚ avoided/yr if switched";

    document.getElementById("ev-highlight").innerHTML =
      '<span class="icon">âš¡</span>' +
      '<strong>' + evCount + ' vehicles</strong> are strong EV candidates. ' +
      'They average <strong>' +
      fmt(evReady.reduce(function(s,v){return s+v.avgDailyKm;},0)/(evReady.length||1), 0) +
      ' km/day</strong> â€” well within EV range. ' +
      'High idle means they waste most fuel at standstill: exactly where EVs excel.';

    var evSorted = vehicles.slice().sort(function (a, b) { return b.evScore - a.evScore; }).slice(0, 10);
    document.getElementById("ev-tbody").innerHTML = evSorted.map(function (v) {
      var verdict = evVerdict(v.evScore);
      var scoreColor = v.evScore >= 70 ? "#107C10" : v.evScore >= 50 ? "#0078D4" : v.evScore >= 35 ? "#7A4F00" : "#D13438";
      return "<tr>" +
        "<td><strong>" + v.name + "</strong></td>" +
        "<td>" + fmt(v.avgDailyKm, 0) + " km</td>" +
        "<td>" + fmt(v.tripsPerDay, 1) + "</td>" +
        "<td>" + fmt(v.idlePct, 1) + "%</td>" +
        "<td>" +
          '<div class="progress-wrap">' +
          '<div class="progress-bg"><div class="progress-fill" style="width:' + v.evScore + '%;background:' + scoreColor + '"></div></div>' +
          '<span class="progress-label" style="color:' + scoreColor + ';font-weight:600">' + v.evScore + '</span>' +
          '</div>' +
        "</td>" +
        "<td><span class='pill " + verdict[1] + "'>" + verdict[0] + "</span></td>" +
        "</tr>";
    }).join("");

    // â”€â”€ Show content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("loading").style.display = "none";
    document.getElementById("content").style.display = "block";
  }

  return {
    initialize: function (api, state, callback) {
      api.getSession(function (session) {
        document.getElementById("db-label").textContent = session.database || "â€”";
      });
      run(api);
      callback();
    },
    focus: function (api, state) {},
    blur:  function (api, state) {}
  };
};
</script>
</body>
</html>
