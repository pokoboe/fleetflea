<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>GreenFleet IQ</title>
  <link rel="stylesheet" href="greenfleet-iq.css">
</head>
<body>

  <!-- Page header -->
  <div class="page-header">
    <div>
      <div class="page-title">ğŸŒ¿ GreenFleet IQ</div>
      <div class="page-subtitle">Fuel waste &amp; EV readiness Â· Last 7 days</div>
    </div>
    <span class="db-label" id="db-label">Loading...</span>
  </div>

  <!-- Error -->
  <div class="error-banner" id="error-banner"></div>

  <!-- Loading -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <span>Fetching fleet data...</span>
  </div>

  <!-- Content (hidden until loaded) -->
  <div id="content" style="display:none">

    <!-- KPI row -->
    <div class="kpi-row">

      <div class="kpi-card green">
        <div class="kpi-label">ğŸŒ COâ‚‚ Emitted</div>
        <div class="kpi-value" id="kpi-co2">â€”<span class="unit">t</span></div>
        <div class="kpi-desc">Estimated from real trip distances</div>
        <div class="kpi-insight" id="kpi-co2-insight"></div>
      </div>

      <div class="kpi-card orange">
        <div class="kpi-label">â±ï¸ Idle Fuel Wasted</div>
        <div class="kpi-value" id="kpi-idle">â€”<span class="unit">L</span></div>
        <div class="kpi-desc">Engine on, not moving</div>
        <div class="kpi-insight" id="kpi-idle-insight"></div>
      </div>

      <div class="kpi-card blue">
        <div class="kpi-label">âš¡ EV-Ready Vehicles</div>
        <div class="kpi-value" id="kpi-ev">â€”<span class="unit"></span></div>
        <div class="kpi-desc">Score â‰¥ 70: range fits, high idle, short trips</div>
        <div class="kpi-insight" id="kpi-ev-insight"></div>
      </div>

    </div>

    <!-- Idle table -->
    <div class="section-card">
      <div class="section-header">
        <span class="section-title">Idle Time â€” Top 10 Worst Offenders</span>
        <span class="pill pill-orange" id="idle-fleet-pct"></span>
      </div>
      <div class="section-body">
        <div class="insight-box" id="idle-highlight"></div>
        <table>
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Idle Time</th>
              <th>% of Engine-On</th>
              <th>Fuel Wasted</th>
              <th>COâ‚‚ Wasted</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="idle-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- EV readiness table -->
    <div class="section-card">
      <div class="section-header">
        <span class="section-title">EV Readiness â€” Top Candidates</span>
        <span class="pill pill-blue" id="ev-saving-pill"></span>
      </div>
      <div class="section-body">
        <div class="insight-box" id="ev-highlight"></div>
        <table>
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Avg Daily km</th>
              <th>Trips / Day</th>
              <th>Idle %</th>
              <th>EV Score</th>
              <th>Verdict</th>
            </tr>
          </thead>
          <tbody id="ev-tbody"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /content -->

<script>
"use strict";

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var CO2_KG_PER_LITRE = 2.31;   // gasoline
var FUEL_L_PER_KM    = 0.10;   // 10 L / 100 km fleet avg
var IDLE_FUEL_L_HR   = 0.8;    // litres / hour idling
var DAYS             = 7;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n, dec) {
  if (n == null || isNaN(n)) return "â€”";
  return Number(n).toLocaleString(undefined, { maximumFractionDigits: dec != null ? dec : 0 });
}
function showError(msg) {
  var el = document.getElementById("error-banner");
  el.textContent = "âš ï¸ " + msg;
  el.style.display = "block";
  document.getElementById("loading").style.display = "none";
}
function evScore(avgDailyKm, idlePct, tripsPerDay) {
  var s = 0;
  // Range fit: â‰¤150 km = full 40pts, linear above
  s += Math.max(0, Math.min(40, (150 - avgDailyKm) / 150 * 40));
  // High idle = EV shines (no idle waste)
  s += Math.min(30, idlePct / 100 * 30);
  // Multiple short trips per day
  s += Math.min(20, tripsPerDay * 7);
  // Base
  s += 10;
  return Math.min(100, Math.round(s));
}
function evVerdict(score) {
  if (score >= 70) return ["EV Ready", "pill-green"];
  if (score >= 50) return ["Good Fit", "pill-blue"];
  if (score >= 35) return ["Consider", "pill-orange"];
  return ["Not Yet", "pill-red"];
}
function progressBar(pct, color) {
  return '<div class="progress-wrap">' +
    '<div class="progress-bg"><div class="progress-fill" style="width:' +
    Math.min(pct, 100) + '%;background:' + color + '"></div></div>' +
    '<span class="progress-label">' + fmt(pct, 0) + '%</span></div>';
}

// â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
geotab.addin["greenfleet-iq"] = function () {
  var apiRef;

  function run(api) {
    apiRef = api;
    var now   = new Date();
    var from  = new Date(now - DAYS * 24 * 3600 * 1000);

    // Parallel: devices + trips
    api.call("Get", { typeName: "Device" }, function (devices) {

      var nameMap = {};
      devices.forEach(function (d) { nameMap[d.id] = d.name; });

      api.call("Get", {
        typeName: "Trip",
        search: {
          fromDate: from.toISOString(),
          toDate:   now.toISOString()
        },
        resultsLimit: 50000
      }, function (trips) {

        render(trips, nameMap);

      }, function (err) { showError("Failed to load trips: " + err); });

    }, function (err) { showError("Failed to load devices: " + err); });
  }

  function render(trips, nameMap) {
    // â”€â”€ Aggregate by vehicle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var byVehicle = {};

    // Detect distance unit from first non-zero trip:
    // JS API returns km (small numbers ~50-500), Python returns meters (50000+)
    // We check: if max raw distance > 5000, it's meters; otherwise km.
    var maxRawDist = 0;
    trips.forEach(function(t) { if ((t.distance||0) > maxRawDist) maxRawDist = t.distance||0; });
    var distDivisor = (maxRawDist > 5000) ? 1000 : 1;

    trips.forEach(function (t) {
      var id = t.device && t.device.id;
      if (!id) return;
      if (!byVehicle[id]) {
        byVehicle[id] = {
          id: id,
          name: nameMap[id] || id,
          distKm: 0, tripCount: 0,
          driveSec: 0, idleSec: 0,
          days: {}
        };
      }
      var v = byVehicle[id];

      // Distance: auto-detect meters vs km
      v.distKm    += (t.distance || 0) / distDivisor;
      v.tripCount += 1;

      // Duration: try multiple formats the JS API might return
      // Format A: { totalSeconds: 1234 }
      // Format B: { ticks: 12340000000 }  (100-ns ticks)
      // Format C: number (raw seconds)
      function parseDuration(d) {
        if (!d) return 0;
        if (typeof d === "number") return d;
        if (d.totalSeconds != null) return d.totalSeconds;
        if (d.ticks != null) return d.ticks / 1e7;
        // ISO 8601 duration string "00:12:34" or "PT12M34S"
        if (typeof d === "string") {
          // "HH:MM:SS" format
          var parts = d.split(":");
          if (parts.length === 3)
            return parseInt(parts[0])*3600 + parseInt(parts[1])*60 + parseFloat(parts[2]);
        }
        return 0;
      }

      v.driveSec += parseDuration(t.drivingDuration);
      v.idleSec  += parseDuration(t.idlingDuration);
      if (t.start) v.days[t.start.substring(0, 10)] = 1;
    });

    var vehicles = Object.values(byVehicle).filter(function (v) {
      return v.tripCount > 0;
    });

    // â”€â”€ Derived metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    vehicles.forEach(function (v) {
      v.idleHrs     = v.idleSec / 3600;
      v.driveHrs    = v.driveSec / 3600;
      v.totalHrs    = v.idleHrs + v.driveHrs;
      v.idlePct     = v.totalHrs > 0 ? v.idleSec / (v.driveSec + v.idleSec) * 100 : 0;
      v.activeDays  = Math.max(Object.keys(v.days).length, 1);
      v.avgDailyKm  = v.distKm / v.activeDays;
      v.tripsPerDay = v.tripCount / v.activeDays;
      v.idleFuelL   = v.idleHrs * IDLE_FUEL_L_HR;
      v.driveFuelL  = v.distKm  * FUEL_L_PER_KM;
      v.totalFuelL  = v.driveFuelL + v.idleFuelL;
      v.co2Kg       = v.totalFuelL * CO2_KG_PER_LITRE;
      v.co2IdleKg   = v.idleFuelL  * CO2_KG_PER_LITRE;
      v.evScore     = evScore(v.avgDailyKm, v.idlePct, v.tripsPerDay);
    });

    // â”€â”€ Fleet totals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var totalCO2Kg    = vehicles.reduce(function (s, v) { return s + v.co2Kg; }, 0);
    var totalIdleFuel = vehicles.reduce(function (s, v) { return s + v.idleFuelL; }, 0);
    var totalFuel     = vehicles.reduce(function (s, v) { return s + v.totalFuelL; }, 0);
    var fleetIdlePct  = totalFuel > 0 ? totalIdleFuel / totalFuel * 100 : 0;
    var evReady       = vehicles.filter(function (v) { return v.evScore >= 70; });

    // â”€â”€ KPI cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var co2T = totalCO2Kg / 1000;
    document.getElementById("kpi-co2").innerHTML =
      fmt(co2T, co2T < 10 ? 1 : 0) + '<span class="unit"> t</span>';
    document.getElementById("kpi-co2-insight").innerHTML =
      'Equiv. <strong>' + fmt(co2T * 1000 / 0.12, 0) + ' km</strong> driven by avg car';

    document.getElementById("kpi-idle").innerHTML =
      fmt(totalIdleFuel, 0) + '<span class="unit"> L</span>';
    document.getElementById("kpi-idle-insight").innerHTML =
      '<strong>' + fmt(fleetIdlePct, 1) + '%</strong> of all fuel burned â€” engine on, going nowhere';

    var evCount = evReady.length;
    document.getElementById("kpi-ev").innerHTML =
      evCount + '<span class="unit"> / ' + vehicles.length + '</span>';
    var potentialCO2T = evReady.reduce(function (s, v) { return s + v.co2Kg; }, 0) / 1000 * 12 * 0.85;
    document.getElementById("kpi-ev-insight").innerHTML =
      'Could avoid <strong>' + fmt(potentialCO2T, 0) + ' t COâ‚‚/year</strong> if switched to EV';

    // â”€â”€ Idle table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("idle-fleet-pct").textContent =
      fmt(fleetIdlePct, 1) + "% fleet idle";

    var worstIdle = vehicles.slice().sort(function (a, b) { return b.idleHrs - a.idleHrs; });
    var topIdle   = worstIdle[0];
    document.getElementById("idle-highlight").innerHTML =
      '<span class="icon">ğŸ’¡</span>' +
      'Eliminating idle on the <strong>top 3 offenders</strong> alone would save ' +
      '<strong>' + fmt(worstIdle.slice(0,3).reduce(function(s,v){return s+v.idleFuelL;},0), 0) +
      ' L of fuel</strong> and <strong>' +
      fmt(worstIdle.slice(0,3).reduce(function(s,v){return s+v.co2IdleKg;},0)/1000, 2) +
      ' t COâ‚‚</strong> this week.';

    var idleTop10 = worstIdle.slice(0, 10);
    document.getElementById("idle-tbody").innerHTML = idleTop10.map(function (v, i) {
      var pctColor = v.idlePct > 25 ? "#D13438" : v.idlePct > 15 ? "#FFB900" : "#107C10";
      var statusCls = v.idlePct > 25 ? "pill-red" : v.idlePct > 15 ? "pill-orange" : "pill-green";
      var statusTxt = v.idlePct > 25 ? "Critical" : v.idlePct > 15 ? "High" : "Normal";
      return "<tr>" +
        "<td><strong>" + v.name + "</strong></td>" +
        "<td>" + fmt(v.idleHrs, 1) + " hrs</td>" +
        "<td class='idle-bar-cell'>" + progressBar(v.idlePct, pctColor) + "</td>" +
        "<td>" + fmt(v.idleFuelL, 0) + " L</td>" +
        "<td>" + fmt(v.co2IdleKg, 0) + " kg</td>" +
        "<td><span class='pill " + statusCls + "'>" + statusTxt + "</span></td>" +
        "</tr>";
    }).join("");

    // â”€â”€ EV table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var annualSavingT = evReady.reduce(function (s, v) { return s + v.co2Kg; }, 0) / 1000 * 12 * 0.85;
    document.getElementById("ev-saving-pill").textContent =
      "~" + fmt(annualSavingT, 0) + " t COâ‚‚ avoided/yr if switched";

    document.getElementById("ev-highlight").innerHTML =
      '<span class="icon">âš¡</span>' +
      '<strong>' + evCount + ' vehicles</strong> are strong EV candidates. ' +
      'They average <strong>' +
      fmt(evReady.reduce(function(s,v){return s+v.avgDailyKm;},0)/(evReady.length||1), 0) +
      ' km/day</strong> â€” well within EV range. ' +
      'High idle means they waste most fuel at standstill: exactly where EVs excel.';

    var evSorted = vehicles.slice().sort(function (a, b) { return b.evScore - a.evScore; }).slice(0, 10);
    document.getElementById("ev-tbody").innerHTML = evSorted.map(function (v) {
      var verdict = evVerdict(v.evScore);
      var scoreColor = v.evScore >= 70 ? "#107C10" : v.evScore >= 50 ? "#0078D4" : v.evScore >= 35 ? "#7A4F00" : "#D13438";
      return "<tr>" +
        "<td><strong>" + v.name + "</strong></td>" +
        "<td>" + fmt(v.avgDailyKm, 0) + " km</td>" +
        "<td>" + fmt(v.tripsPerDay, 1) + "</td>" +
        "<td>" + fmt(v.idlePct, 1) + "%</td>" +
        "<td>" +
          '<div class="progress-wrap">' +
          '<div class="progress-bg"><div class="progress-fill" style="width:' + v.evScore + '%;background:' + scoreColor + '"></div></div>' +
          '<span class="progress-label" style="color:' + scoreColor + ';font-weight:600">' + v.evScore + '</span>' +
          '</div>' +
        "</td>" +
        "<td><span class='pill " + verdict[1] + "'>" + verdict[0] + "</span></td>" +
        "</tr>";
    }).join("");

    // â”€â”€ Show content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("loading").style.display = "none";
    document.getElementById("content").style.display = "block";
  }

  return {
    initialize: function (api, state, callback) {
      api.getSession(function (session) {
        document.getElementById("db-label").textContent = session.database || "â€”";
      });
      run(api);
      callback();
    },
    focus: function (api, state) {},
    blur:  function (api, state) {}
  };
};
</script>
</body>
</html>
