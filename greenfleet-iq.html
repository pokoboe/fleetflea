<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GreenFleet IQ (Zenith)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    :root {
      --app-gap: 16px;
    }
    body {
      margin: 0;
      font-family: var(--zenith-font-family, 'Segoe UI', sans-serif);
      background: var(--zenith-neutral-0, #fff);
      color: var(--zenith-neutral-900, #201f1e);
    }
    #app { padding: 20px; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; }
    .tabs { display:flex; gap:8px; margin-bottom:16px; }
    .grid-5 { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
    .kpi-card {
      border: 1px solid var(--zenith-neutral-100, #edebe9);
      border-radius: 8px;
      padding: 12px;
      background: #fff;
    }
    .kpi-label { font-size: 12px; color: var(--zenith-neutral-600, #605e5c); }
    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; }
    .kpi-sub { font-size: 12px; color: var(--zenith-neutral-600, #605e5c); }
    .card {
      border: 1px solid var(--zenith-neutral-100, #edebe9);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      background: #fff;
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid var(--zenith-neutral-100, #edebe9); }
    .table-wrap { overflow-x:auto; }
    .badge { border-radius: 999px; padding: 2px 8px; font-size: 11px; }
    .badge-good { background: #dff6dd; color: #0f6b0f; }
    .badge-mid { background: #fff4ce; color: #8a5300; }
    .badge-bad { background: #fde7e9; color: #a4262c; }
    .section { display:none; }
    .section.active { display:block; }
    .ace-row { display:flex; gap:10px; align-items:flex-end; }
    .quick { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
  </style>
  <link rel="stylesheet" href="https://esm.sh/@geotab/zenith/dist/index.css">
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import React, { useEffect, useMemo, useState } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import { FeedbackProvider, Button, TextInput, Alert, Waiting } from 'https://esm.sh/@geotab/zenith@9.0.0';

    const h = React.createElement;

    const CO2_PER_LITRE = 2.31;
    const FUEL_PER_KM = 0.10;
    const IDLE_FUEL_L_HR = 0.8;

    function fmt(n, dec = 0) {
      if (n === null || n === undefined || Number.isNaN(n)) return '—';
      return Number(n).toLocaleString(undefined, { maximumFractionDigits: dec });
    }
    function pct(a, b) { return b > 0 ? (a / b * 100) : 0; }

    function aggregateByVehicle(trips, deviceMap) {
      const byVehicle = {};
      trips.forEach((trip) => {
        const id = trip.device && trip.device.id;
        if (!id) return;
        if (!byVehicle[id]) {
          byVehicle[id] = {
            id,
            name: deviceMap[id] || id,
            distanceKm: 0,
            driveSec: 0,
            idleSec: 0,
            tripCount: 0,
            activeDays: {}
          };
        }
        const v = byVehicle[id];
        v.distanceKm += (trip.distance || 0) / 1000;
        v.driveSec += trip.drivingDuration?.ticks ? (trip.drivingDuration.ticks / 10000000) : 0;
        v.idleSec += trip.idlingDuration?.ticks ? (trip.idlingDuration.ticks / 10000000) : 0;
        v.tripCount += 1;
        if (trip.start) v.activeDays[String(trip.start).substring(0, 10)] = true;
      });

      Object.keys(byVehicle).forEach((id) => {
        const v = byVehicle[id];
        v.idleHrs = v.idleSec / 3600;
        v.driveHrs = v.driveSec / 3600;
        v.totalHrs = v.idleHrs + v.driveHrs;
        v.idlePct = pct(v.idleHrs, v.totalHrs);
        v.activeDayCount = Object.keys(v.activeDays).length || 1;
        v.avgDailyKm = v.distanceKm / v.activeDayCount;
        v.tripsPerDay = v.tripCount / v.activeDayCount;

        v.fuelDrive = v.distanceKm * FUEL_PER_KM;
        v.fuelIdle = v.idleHrs * IDLE_FUEL_L_HR;
        v.totalFuel = v.fuelDrive + v.fuelIdle;
        v.co2Total = v.totalFuel * CO2_PER_LITRE;
        v.co2Idle = v.fuelIdle * CO2_PER_LITRE;

        const scoreKm = v.avgDailyKm <= 200 ? Math.max(0, (200 - v.avgDailyKm) / 200 * 40) : 0;
        const scoreIdle = Math.min(v.idlePct / 100 * 30, 30);
        const scoreTrips = v.tripsPerDay >= 2 ? 20 : v.tripsPerDay * 10;
        v.evScore = Math.min(100, Math.round(scoreKm + scoreIdle + scoreTrips + 10));
      });

      return Object.values(byVehicle).filter((v) => v.tripCount > 0);
    }

    function geotabCall(api, method, params) {
      return new Promise((resolve, reject) => api.call(method, params, resolve, reject));
    }

    function App() {
      const [api, setApi] = useState(null);
      const [db, setDb] = useState('Connecting...');
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState('');
      const [tab, setTab] = useState('overview');
      const [trips, setTrips] = useState([]);
      const [deviceMap, setDeviceMap] = useState({});
      const [aceInput, setAceInput] = useState('');
      const [aceLoading, setAceLoading] = useState(false);
      const [aceResult, setAceResult] = useState(null);

      useEffect(() => {
        window.__setGeotabApi = (apiRef, session) => {
          setApi(apiRef);
          setDb(session?.database || 'Fleet');
        };
      }, []);

      useEffect(() => {
        if (!api) return;
        let active = true;
        (async () => {
          try {
            setLoading(true);
            const devices = await geotabCall(api, 'Get', { typeName: 'Device' });
            const map = {};
            devices.forEach((d) => { map[d.id] = d.name; });
            const now = new Date();
            const from = new Date(now.getTime() - 30 * 24 * 3600 * 1000);
            const tripRows = await geotabCall(api, 'Get', {
              typeName: 'Trip',
              search: { fromDate: from.toISOString(), toDate: now.toISOString() },
              resultsLimit: 50000
            });
            if (!active) return;
            setDeviceMap(map);
            setTrips(tripRows || []);
            setError('');
          } catch (e) {
            if (active) setError(`Failed to load fleet data: ${e?.message || e}`);
          } finally {
            if (active) setLoading(false);
          }
        })();
        return () => { active = false; };
      }, [api]);

      const vehicles = useMemo(() => aggregateByVehicle(trips, deviceMap), [trips, deviceMap]);
      const overview = useMemo(() => {
        const totalCO2 = vehicles.reduce((s, v) => s + v.co2Total, 0) / 1000;
        const totalFuel = vehicles.reduce((s, v) => s + v.totalFuel, 0);
        const totalIdleH = vehicles.reduce((s, v) => s + v.idleHrs, 0);
        const totalKm = vehicles.reduce((s, v) => s + v.distanceKm, 0);
        const avgEff = totalKm > 0 ? (totalFuel / totalKm * 100) : 0;
        return { totalCO2, totalFuel, totalIdleH, totalKm, avgEff };
      }, [vehicles]);

      async function sendAce() {
        if (!api || !aceInput.trim() || aceLoading) return;
        setAceLoading(true);
        setAceResult(null);
        try {
          const createRes = await geotabCall(api, 'GetAceResults', {
            serviceName: 'dna-planet-orchestration',
            functionName: 'create-chat',
            customerData: true,
            functionParameters: {}
          });
          const c = createRes?.apiResult?.results?.[0] || {};
          const chatId = c.chat_id;
          if (!chatId) throw new Error('No chat_id from Ace');

          const promptRes = await geotabCall(api, 'GetAceResults', {
            serviceName: 'dna-planet-orchestration',
            functionName: 'send-prompt',
            customerData: true,
            functionParameters: { chat_id: chatId, prompt: aceInput.trim() }
          });
          const p = promptRes?.apiResult?.results?.[0] || {};
          const msgId = p.message_group_id || p.message_group?.id;
          if (!msgId) throw new Error('No message_group_id from Ace');

          for (let i = 0; i < 30; i++) {
            await new Promise((r) => setTimeout(r, 5000));
            const pollRes = await geotabCall(api, 'GetAceResults', {
              serviceName: 'dna-planet-orchestration',
              functionName: 'get-message-group',
              customerData: true,
              functionParameters: { chat_id: chatId, message_group_id: msgId }
            });
            const r = pollRes?.apiResult?.results?.[0] || {};
            const status = r.message_group?.status?.status;
            if (status === 'DONE') {
              const messages = r.message_group?.messages || {};
              const first = messages[Object.keys(messages)[0]] || {};
              setAceResult({
                reasoning: first.reasoning || '',
                preview: first.preview_array || []
              });
              setAceLoading(false);
              return;
            }
            if (status === 'FAILED') throw new Error('Ace query failed');
          }
          throw new Error('Ace timed out');
        } catch (e) {
          setAceResult({ error: e?.message || String(e) });
        } finally {
          setAceLoading(false);
        }
      }

      const sortedIdle = [...vehicles].sort((a, b) => b.idlePct - a.idlePct);
      const sortedEV = [...vehicles].sort((a, b) => b.evScore - a.evScore);
      const ready = sortedEV.filter((v) => v.evScore >= 75).length;

      return h(FeedbackProvider, null,
        h('div', null,
          h('div', { className: 'header' },
            h('div', null,
              h('h2', { style: { margin: 0 } }, 'GreenFleet IQ'),
              h('div', { style: { color: 'var(--zenith-neutral-600,#605e5c)', fontSize: '12px' } }, `${db} · Last 30 days`)
            ),
            h(Button, { variant: 'secondary', onClick: () => window.location.reload() }, 'Refresh')
          ),

          h('div', { className: 'tabs' },
            ['overview', 'idle', 'ev', 'ai'].map((t) => h(Button, { key: t, variant: tab === t ? 'primary' : 'tertiary', onClick: () => setTab(t) }, t.toUpperCase()))
          ),

          error ? h(Alert, { variant: 'error' }, error) : null,
          loading ? h('div', { style: { marginTop: '24px' } }, h(Waiting, { size: 'large' })) : null,

          !loading && h('div', { className: `section ${tab === 'overview' ? 'active' : ''}` },
            h('div', { className: 'grid-5' },
              h('div', { className: 'kpi-card' }, h('div', { className: 'kpi-label' }, 'Total CO₂'), h('div', { className: 'kpi-value' }, `${fmt(overview.totalCO2, 1)} t`), h('div', { className: 'kpi-sub' }, 'Past 30 days')),
              h('div', { className: 'kpi-card' }, h('div', { className: 'kpi-label' }, 'Fuel Used'), h('div', { className: 'kpi-value' }, `${fmt(overview.totalFuel / 1000, 1)} kL`), h('div', { className: 'kpi-sub' }, 'Estimated from distance')),
              h('div', { className: 'kpi-card' }, h('div', { className: 'kpi-label' }, 'Distance'), h('div', { className: 'kpi-value' }, `${fmt(overview.totalKm / 1000)} K km`), h('div', { className: 'kpi-sub' }, 'All vehicles')),
              h('div', { className: 'kpi-card' }, h('div', { className: 'kpi-label' }, 'Fleet Avg'), h('div', { className: 'kpi-value' }, `${fmt(overview.avgEff, 1)} L/100km`), h('div', { className: 'kpi-sub' }, 'Fuel efficiency')),
              h('div', { className: 'kpi-card' }, h('div', { className: 'kpi-label' }, 'Idle Hours'), h('div', { className: 'kpi-value' }, `${fmt(overview.totalIdleH)} h`), h('div', { className: 'kpi-sub' }, 'Engine on, not moving'))
            )
          ),

          !loading && h('div', { className: `section ${tab === 'idle' ? 'active' : ''}` },
            h('div', { className: 'card' },
              h('h3', null, 'Idle Analyzer'),
              h('div', { className: 'table-wrap' },
                h('table', null,
                  h('thead', null, h('tr', null,
                    h('th', null, 'Vehicle'), h('th', null, 'Idle hrs'), h('th', null, 'Idle %'), h('th', null, 'Wasted Fuel (L)'), h('th', null, 'CO Idle (kg)'), h('th', null, 'Status')
                  )),
                  h('tbody', null, sortedIdle.map((v) => {
                    const status = v.idlePct > 25 ? ['Critical', 'badge-bad'] : v.idlePct > 15 ? ['High', 'badge-mid'] : ['Normal', 'badge-good'];
                    return h('tr', { key: v.id },
                      h('td', null, v.name),
                      h('td', null, fmt(v.idleHrs, 1)),
                      h('td', null, `${fmt(v.idlePct, 1)}%`),
                      h('td', null, fmt(v.fuelIdle, 0)),
                      h('td', null, fmt(v.co2Idle, 0)),
                      h('td', null, h('span', { className: `badge ${status[1]}` }, status[0]))
                    );
                  }))
                )
              )
            )
          ),

          !loading && h('div', { className: `section ${tab === 'ev' ? 'active' : ''}` },
            h('div', { className: 'grid-5' },
              h('div', { className: 'kpi-card' }, h('div', { className: 'kpi-label' }, 'EV Ready'), h('div', { className: 'kpi-value' }, String(ready)), h('div', { className: 'kpi-sub' }, 'Score ≥ 75'))
            ),
            h('div', { className: 'card' },
              h('h3', null, 'EV Readiness'),
              h('div', { className: 'table-wrap' },
                h('table', null,
                  h('thead', null, h('tr', null,
                    h('th', null, 'Vehicle'), h('th', null, 'Avg Daily km'), h('th', null, 'Idle %'), h('th', null, 'Trips/Day'), h('th', null, 'EV Score')
                  )),
                  h('tbody', null, sortedEV.map((v) => h('tr', { key: v.id },
                    h('td', null, v.name),
                    h('td', null, fmt(v.avgDailyKm, 0)),
                    h('td', null, `${fmt(v.idlePct, 1)}%`),
                    h('td', null, fmt(v.tripsPerDay, 1)),
                    h('td', null, fmt(v.evScore, 0))
                  )))
                )
              )
            )
          ),

          !loading && h('div', { className: `section ${tab === 'ai' ? 'active' : ''}` },
            h('div', { className: 'card' },
              h('h3', null, 'Geotab Ace Insights'),
              h('div', { className: 'quick' },
                h(Button, { variant: 'tertiary', onClick: () => setAceInput('Which vehicles have the highest idle time as % of total engine-on time last 30 days? Return columns: device_name, idle_pct, idle_hours') }, 'Top idlers'),
                h(Button, { variant: 'tertiary', onClick: () => setAceInput('Which vehicles drove the most distance last 30 days? Return columns: device_name, total_km, trip_count') }, 'Top distance')
              ),
              h('div', { className: 'ace-row' },
                h('div', { style: { flex: 1 } }, h(TextInput, { label: 'Ask Ace', value: aceInput, onChange: (e) => setAceInput(e.target.value) })),
                h(Button, { variant: 'primary', disabled: aceLoading, onClick: sendAce }, aceLoading ? 'Analyzing...' : 'Ask AI')
              ),
              aceLoading ? h('div', { style: { marginTop: 12 } }, h(Waiting, { size: 'medium' })) : null,
              aceResult?.error ? h('div', { style: { marginTop: 12 } }, h(Alert, { variant: 'error' }, aceResult.error)) : null,
              aceResult?.reasoning ? h('p', { style: { color: 'var(--zenith-neutral-700,#484644)' } }, aceResult.reasoning) : null,
              aceResult?.preview?.length ? h('div', { className: 'table-wrap' }, h('table', null,
                h('tbody', null, aceResult.preview.map((row, idx) => h('tr', { key: idx },
                  Object.values(row).map((v, i) => h('td', { key: i }, String(v)))
                )))
              )) : null
            )
          )
        )
      );
    }

    createRoot(document.getElementById('app')).render(h(App));
  </script>

  <script>
    geotab.addin['greenfleet-iq'] = function() {
      return {
        initialize: function(api, state, callback) {
          api.getSession(function(session) {
            if (window.__setGeotabApi) {
              window.__setGeotabApi(api, session);
            } else {
              setTimeout(function() { window.__setGeotabApi && window.__setGeotabApi(api, session); }, 500);
            }
          });
          callback();
        },
        focus: function() {},
        blur: function() {}
      };
    };
  </script>
</body>
</html>
